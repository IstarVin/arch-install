#!/bin/bash

misc() {
    # Optimizations
    nc=$(grep -c ^processor /proc/cpuinfo)
    TOTAL_MEM=$(cat /proc/meminfo | grep -i 'memtotal' | grep -o '[[:digit:]]*')
    if [[ $TOTAL_MEM -gt 8000000 ]]; then
        sed -i "s/#MAKEFLAGS=\"-j2\"/MAKEFLAGS=\"-j$nc\"/g" /etc/makepkg.conf
        sed -i "s/COMPRESSXZ=(xz -c -z -)/COMPRESSXZ=(xz -c -T $nc -z -)/g" /etc/makepkg.conf
    fi

    # Setup locale
    echo "en_US.UTF-8 UTF-8" >>/etc/locale.gen
    locale-gen
    echo "LANG=en_US.UTF-8" >/etc/locale.conf

    # Setup time and date
    ln -sf /usr/share/zoneinfo/Asia/Manila /etc/localtime
    hwclock --systohc

    # enable nm
    systemctl enable NetworkManager

	# Add crypttab
	tee -a /etc/crypttab > /dev/null <<-EOF
		aj-drive UUID=055372e2-c647-4e7c-acf4-2fb5ad83f338 /root/keyfile nofail
	EOF

	# Add Swapfile
	btrfs subvolume create /swap
	btrfs filesystem mkswapfile --size 50g --uuid clear /swap/swapfile
	tee -a /etc/fstab > /dev/null <<-EOF
		#Swap
		/swap/swapfile none swap defaults 0 0
	EOF

	# Setup NVIDIA
	pacman -S --needed --noconfirm nvidia-open-dkms nvidia-utils
}

setup_ajdisk() {
	mkdir /mnt/AJ
	chown 1000:1000 /mnt/AJ
	tee -a /etc/fstab > /dev/null <<-EOF
		# AJ
		UUID=a670b2de-99ca-43e3-8c34-3fc50150c12e /mnt/AJ btrfs defaults 0 2
	EOF
}

setup_chaoticaur() {
	pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
	pacman-key --lsign-key 3056513887B78AEB

	pacman --noconfirm -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
	pacman --noconfirm -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'

	tee -a /etc/pacman.conf > /dev/null <<-EOF
		[chaotic-aur]
		Include = /etc/pacman.d/chaotic-mirrorlist
	EOF

	pacman -Sy --noconfirm --needed yay
}

main() {
	if [[ "$*" == *"--chaotic-aur"* ]]; then
		setup_chaoticaur
	fi

	setup_ajdisk
	misc
}

if [[ "$*" != *"--source"* ]]; then
	main "$@"
fi
