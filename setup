#!/bin/bash

misc() {
	# Optimizations
	nc=$(grep -c ^processor /proc/cpuinfo)
	TOTAL_MEM=$(cat /proc/meminfo | grep -i 'memtotal' | grep -o '[[:digit:]]*')
	if [[ $TOTAL_MEM -gt 8000000 ]]; then
		sed -i "s/#MAKEFLAGS=\"-j2\"/MAKEFLAGS=\"-j$nc\"/g" /etc/makepkg.conf
		sed -i "s/COMPRESSXZ=(xz -c -z -)/COMPRESSXZ=(xz -c -T $nc -z -)/g" /etc/makepkg.conf
	fi

	# Setup locale
	echo "en_US.UTF-8 UTF-8" >>/etc/locale.gen
	locale-gen
	echo "LANG=en_US.UTF-8" >/etc/locale.conf

	# Setup time and date
	ln -sf /usr/share/zoneinfo/Asia/Manila /etc/localtime
	hwclock --systohc

	# enable nm
	tee /etc/NetworkManager/conf.d/10_nodns.conf > /dev/null <<-EOF
		[main]
		dns=none
	EOF
	systemctl enable NetworkManager

	# Add crypttab
	uuid="7d2df54f-60df-410c-b5a1-d867a7d4f0c9"
	if blkid | grep $uuid > /dev/null; then
		tee -a /etc/crypttab > /dev/null <<-EOF
			aj-drive UUID=${uuid} /root/keyfile nofail
		EOF
	fi

	# Add Swapfile
	btrfs subvolume create /swap
	btrfs filesystem mkswapfile --size 50g --uuid clear /swap/swapfile
	if [ $? -eq 0 ]; then
		tee -a /etc/fstab > /dev/null <<-EOF
			#Swap
			/swap/swapfile none swap defaults 0 0
		EOF
	fi

	echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
	sysctl -p

	echo "nameserver 1.1.1.1" >> /etc/resolv.conf
}

setup_ajdisk() {
	mkdir /mnt/AJ
	chown 1000:1000 /mnt/AJ
	tee -a /etc/fstab > /dev/null <<-EOF
		# AJ
		/dev/mapper/aj-drive /mnt/AJ ext4 defaults,noatime,nodiratime 0 2
	EOF
}

secure_boot() {
	# Install required packages
	pacman -S --needed --noconfirm sbctl tpm2-tss

	# Check if Secure Boot is supported
	if ! sbctl status &>/dev/null; then
		echo "Error: Secure Boot is not supported on this system"
		return 1
	fi

	# Check if system is in Setup Mode
	if ! sbctl status | grep -q "Setup Mode.*Enabled"; then
		echo "Warning: System is not in Setup Mode"
		echo "Please enable Setup Mode in UEFI/BIOS settings and clear existing keys"
		echo "Then run this function again"
		return 1
	fi

	# Create custom Secure Boot keys
	echo "Creating custom Secure Boot keys..."
	sbctl create-keys

	# Enroll the keys (with Microsoft keys for compatibility)
	echo "Enrolling Secure Boot keys..."
	sbctl enroll-keys -m

	# Find and sign bootloader and kernel files
	echo "Signing bootloader and kernel files..."

	# Sign GRUB bootloader
	if [ -f "/boot/grub/x86_64-efi/core.efi" ]; then
		sbctl sign -s /boot/grub/x86_64-efi/core.efi
	fi
	if [ -f "/boot/grub/x86_64-efi/grub.efi" ]; then
		sbctl sign -s /boot/grub/x86_64-efi/grub.efi
	fi
	if [ -f "/boot/EFI/GRUB/grubx64.efi" ]; then
		sbctl sign -s /boot/EFI/GRUB/grubx64.efi
	fi
	if [ -f "/boot/EFI/systemd/systemd-bootx64.efi" ]; then
		sbctl sign -s /boot/EFI/systemd/systemd-bootx64.efi
	fi

	# Sign kernel and initramfs
	for kernel in /boot/vmlinuz-*; do
		if [ -f "$kernel" ]; then
			sbctl sign -s "$kernel"
		fi
	done

	# Sign EFI binaries
	if [ -f "/boot/EFI/BOOT/BOOTX64.EFI" ]; then
		sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI
	fi

	# Verify signatures
	echo "Verifying signatures..."
	sbctl verify

	echo "Secure Boot setup complete!"
	echo "Status:"
	sbctl status
	echo ""
	echo "IMPORTANT: Reboot and enable Secure Boot in UEFI/BIOS settings"
}

main() {
	setup_ajdisk
	misc
}

if [[ "$*" != *"--source"* ]]; then
	main "$@"
fi
